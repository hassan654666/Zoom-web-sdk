<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoom Meeting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">

  <!-- Zoom Embedded SDK -->
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>

  <style>
    html, body {
      margin: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
      position: fixed;
      top: 0; left: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #meetingContainer, #meetingSDKElement {
      width: 100vw;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: #000;
    }

    /* Enforce full viewport for Zoom container */
    #meetingSDKElement > div {
      width: 100vw !important;
      height: 100vh !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
    }

    /* Zoom toolbar / footer styling */
    [class*="footer"], [class*="toolbar"], [class*="control-bar"] {
      position: fixed !important;
      bottom: 8px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      z-index: 10000 !important;
      background: rgba(0,0,0,0.2) !important;
      border-radius: 10px;
      padding: 6px 10px;
      display: flex;
      justify-content: center;
      pointer-events: auto;
    }

    /* Participant video grid fix */
    [class*="video-container"], [class*="video-item"] {
      width: 100% !important;
      height: 100% !important;
    }

    /* Self video floating PIP */
    .self-video-pip {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 160px;
      height: 120px;
      z-index: 11000;
      border: 2px solid #fff;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    .self-video-pip video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Hide original local tile but keep active */
    .self-video-original {
      opacity: 0 !important;
      width: 1px !important;
      height: 1px !important;
      position: absolute !important;
      left: -9999px !important;
    }

    /* Fullscreen tile */
    .tile-fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: #000 !important;
      z-index: 10999 !important;
    }

    .tile-fullscreen-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 14px;
      cursor: pointer;
      z-index: 12000;
    }

    @media (orientation: portrait) {
      .self-video-pip { width: 120px; height: 160px; }
    }
  </style>
</head>

<body>
  <div id="meetingContainer">
    <div id="meetingSDKElement"></div>
  </div>

  <div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:black;color:white;z-index:9999;">
    Joining meeting...
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const meetingNumber = params.get("meetingNumber");
    const signature = decodeURIComponent(params.get("signature") || "");
    const sdkKey = params.get("sdkKey");
    const userName = decodeURIComponent(params.get("name") || "Guest");
    const password = decodeURIComponent(params.get("password") || "").trim();

    const client = ZoomMtgEmbedded.createClient();

    const meetingSDKElement = document.getElementById('meetingSDKElement');
    const loadingEl = document.getElementById('loading');

    const zmConfig = {
      sdkKey,
      signature,
      meetingNumber,
      userName,
      password,
      success: () => console.log("✅ Meeting joined"),
      error: err => console.error("❌ Join error", err)
    };

    client.init({
      zoomAppRoot: meetingSDKElement,
      language: 'en-US',
      customize: {
        video: {
          isResizable: true,
          viewSizes: { default: { width: "100vw", height: "100vh" } }
        },
        toolbar: { alwaysShow: true }
      }
    });

    client.join(zmConfig).then(() => {
      loadingEl.style.display = 'none';
      startLayoutFix();
    }).catch(err => {
      loadingEl.textContent = "Failed to join: " + err.message;
    });

    /* ---------- Layout fix & custom UI ---------- */
    let pipEl = null;

    function startLayoutFix() {
      enforceFullscreen();
      addFullscreenButtons();
      createSelfPIP();
      window.addEventListener('resize', enforceFullscreen);
      new MutationObserver(() => {
        enforceFullscreen();
        createSelfPIP();
        addFullscreenButtons();
      }).observe(document.body, { childList: true, subtree: true });
    }

    function enforceFullscreen() {
      meetingSDKElement.style.width = innerWidth + 'px';
      meetingSDKElement.style.height = innerHeight + 'px';
      document.querySelectorAll('#meetingSDKElement > div').forEach(d => {
        d.style.width = innerWidth + 'px';
        d.style.height = innerHeight + 'px';
        d.style.position = 'fixed';
        d.style.top = 0;
        d.style.left = 0;
      });
    }

    function createSelfPIP() {
      if (pipEl) return;
      const vids = meetingSDKElement.querySelectorAll('video');
      if (!vids.length) return;

      let localVid = null;
      vids.forEach(v => {
        const parent = v.closest('[class*="video-container"]');
        if (parent && parent.innerText.includes(userName)) {
          localVid = v;
          parent.classList.add('self-video-original');
        }
      });
      if (!localVid) return;

      pipEl = document.createElement('div');
      pipEl.className = 'self-video-pip';
      const pipVid = document.createElement('video');
      pipVid.autoplay = true;
      pipVid.muted = true;
      pipVid.playsInline = true;
      pipVid.srcObject = localVid.srcObject;
      pipEl.appendChild(pipVid);
      document.body.appendChild(pipEl);
    }

    function addFullscreenButtons() {
      const tiles = meetingSDKElement.querySelectorAll('[class*="video-container"], [class*="video-item"]');
      tiles.forEach(tile => {
        if (tile.querySelector('.tile-fullscreen-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'tile-fullscreen-btn';
        btn.textContent = '⤢';
        btn.onclick = (e) => {
          e.stopPropagation();
          const isFull = tile.classList.toggle('tile-fullscreen');
          document.querySelectorAll('[class*="video-container"], [class*="video-item"]').forEach(t => {
            if (t !== tile) t.style.display = isFull ? 'none' : '';
          });
        };
        tile.style.position = 'relative';
        tile.appendChild(btn);
      });
    }
  </script>
</body>
</html>
