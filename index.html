<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"/>
  <title>Zoom Meeting</title>

  <!-- Zoom SDK v4.0.7 -->
  <script src="https://source.zoom.us/4.0.7/lib/vendor/react.min.js"></script>
  <script src="https://source.zoom.us/4.0.7/lib/vendor/react-dom.min.js"></script>
  <script src="https://source.zoom.us/4.0.7/lib/vendor/redux.min.js"></script>
  <script src="https://source.zoom.us/4.0.7/lib/vendor/redux-thunk.min.js"></script>
  <script src="https://source.zoom.us/4.0.7/lib/vendor/lodash.min.js"></script>
  <script src="https://source.zoom.us/4.0.7/zoom-meeting-embedded-4.0.7.min.js"></script>

  <style>
    /* your existing styles */
  </style>
</head>
<body>
  <div id="meetingContainer">
    <div id="meetingSDKElement"></div>
  </div>
  <div id="loading">Joining meeting...</div>
  <div id="error">â€¦</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const meetingNumber = params.get("meetingNumber");
    const signature = decodeURIComponent(params.get("signature") || "");
    const sdkKey = params.get("sdkKey");
    const userName = decodeURIComponent(params.get("name") || "Guest");
    const password = decodeURIComponent(params.get("password") || "").trim();

    let client = null;

    async function startMeeting() {
      try {
        if (!meetingNumber || !signature || !sdkKey) throw new Error('Missing meeting params');

        client = window.ZoomMtgEmbedded.createClient();

        await client.init({
          zoomAppRoot: document.getElementById('meetingSDKElement'),
          language: 'en-US',
          patchJsMedia: true,
          // If v4 requires leaveUrl:
          // leaveUrl: window.location.href
        });

        await client.join({
          sdkKey,
          signature,
          meetingNumber,
          password,
          userName,
          role: 0 // add role if required by v4
        });

        document.getElementById('loading').style.display = 'none';

        // connection-change listener
        client.on('connection-change', payload => {
          if (payload.state === 'Closed') {
            notifyAppAndClose();
          }
        });

      } catch (error) {
        console.error('Join failed:', error);
        showError(error.message || 'Join failed');
      }
    }

    function notifyAppAndClose() {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ action: 'meetingEnded' }));
      } else {
        alert('Meeting ended');
      }
    }

    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
      document.getElementById('errorMessage').textContent = msg;
    }

    window.addEventListener('DOMContentLoaded', startMeeting);
  </script>
</body>
</html>
