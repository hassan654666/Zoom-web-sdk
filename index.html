<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Zoom Meeting (Embedded)</title>

  <!-- Zoom Embedded SDK -->
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>

  <style>
    /* --- Reset and base styles --- */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      touch-action: manipulation;
    }

    /* --- Main layout container --- */
    #meetingContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #000;
    }

    /* --- Video area --- */
    #mainVideoContainer {
      flex: 1;
      background: #000;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0; /* Important for flex children */
    }

    /* --- SDK container --- */
    #meetingSDKElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      pointer-events: none; /* Let our custom UI handle interactions */
      z-index: 1;
    }

    #meetingSDKElement > * {
      pointer-events: auto; /* But allow SDK content to be interactive */
    }

    /* --- Thumbnail bar --- */
    #thumbnailBar {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      height: 90px;
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%);
      display: flex;
      align-items: center;
      padding: 8px 12px;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      z-index: 100;
      transition: opacity 0.3s ease, transform 0.3s ease;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
    }

    #thumbnailBar::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
    }

    #thumbnailBar.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }

    .thumbnail {
      flex: 0 0 auto;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      background: #111;
      border: 2px solid transparent;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    .thumbnail.active {
      border-color: #2D8CFF;
    }

    .thumbnail video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .thumbnail .thumb-name {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- Control overlay --- */
    #controlOverlay {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      display: flex;
      gap: 12px;
      padding: 8px 16px;
      background: rgba(0,0,0,0.7);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    #controlOverlay button {
      background: rgba(255,255,255,0.15);
      border: none;
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #controlOverlay button:active {
      background: rgba(255,255,255,0.25);
    }

    /* --- Bottom modals --- */
    .bottom-modal {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: min(70%, 500px);
      background: rgba(20,20,20,0.98);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      backdrop-filter: blur(20px);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      overflow: hidden;
    }

    .bottom-modal.open {
      transform: translateY(0);
    }

    .bottom-modal .modal-header {
      padding: 16px 20px;
      color: #fff;
      font-weight: 600;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }

    .bottom-modal .modal-body {
      flex: 1;
      overflow: auto;
      padding: 16px 20px;
      background: transparent;
      color: #fff;
    }

    .modal-close-btn {
      background: #2D8CFF;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      min-width: 60px;
      min-height: 36px;
    }

    /* --- PIP self video --- */
    .self-video-pip {
      position: fixed;
      right: 12px;
      bottom: 170px;
      width: 120px;
      height: 90px;
      border-radius: 8px;
      z-index: 150;
      border: 2px solid rgba(255,255,255,0.8);
      overflow: hidden;
      background: #000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      display: none;
    }

    .self-video-pip video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* --- Loading and error states --- */
    #loading, #error {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 10000;
      background: #000;
    }

    #error {
      display: none;
      text-align: center;
      padding: 20px;
    }

    #error h2 {
      margin-bottom: 16px;
      font-size: 20px;
    }

    #error p {
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .retry-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: #2D8CFF;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      min-width: 120px;
      min-height: 44px;
    }

    /* --- Responsive design --- */
    @media (max-width: 640px) {
      .thumbnail {
        width: 70px;
        height: 70px;
      }
      
      .self-video-pip {
        width: 100px;
        height: 75px;
        bottom: 160px;
      }
      
      #controlOverlay {
        bottom: 8px;
        padding: 6px 12px;
      }
      
      #controlOverlay button {
        padding: 10px 12px;
        min-width: 40px;
        min-height: 40px;
      }
      
      .bottom-modal {
        height: min(80%, 500px);
      }
    }

    @media (max-width: 480px) {
      .thumbnail {
        width: 60px;
        height: 60px;
      }
      
      #thumbnailBar {
        bottom: 65px;
        height: 80px;
      }
    }

    /* --- Utility classes --- */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div id="meetingContainer">
    <div id="mainVideoContainer">
      <!-- Main video will be placed here -->
    </div>
    <div id="meetingSDKElement"></div>
  </div>

  <!-- Thumbnails strip -->
  <div id="thumbnailBar" aria-label="Participant thumbnails"></div>

  <!-- Control overlay -->
  <div id="controlOverlay" role="toolbar" aria-label="Meeting controls">
    <button id="chatBtn" aria-label="Chat">üí¨</button>
    <button id="participantsBtn" aria-label="Participants">üë•</button>
    <button id="shareBtn" aria-label="Share screen">üñ•Ô∏è</button>
    <button id="settingsBtn" aria-label="Settings">‚öôÔ∏è</button>
    <button id="leaveBtn" aria-label="Leave meeting" style="background: #e53e3e;">üìû</button>
  </div>

  <!-- Bottom modals -->
  <div id="chatModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="chatModalTitle">
    <div class="modal-header">
      <div id="chatModalTitle">Chat</div>
      <button class="modal-close-btn" onclick="closeBottomModal('chat')">Close</button>
    </div>
    <div id="chatModalBody" class="modal-body"></div>
  </div>

  <div id="participantsModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="participantsModalTitle">
    <div class="modal-header">
      <div id="participantsModalTitle">Participants</div>
      <button class="modal-close-btn" onclick="closeBottomModal('participants')">Close</button>
    </div>
    <div id="participantsModalBody" class="modal-body"></div>
  </div>

  <div id="settingsModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="settingsModalTitle">
    <div class="modal-header">
      <div id="settingsModalTitle">Settings</div>
      <button class="modal-close-btn" onclick="closeBottomModal('settings')">Close</button>
    </div>
    <div id="settingsModalBody" class="modal-body"></div>
  </div>

  <div id="shareModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="shareModalTitle">
    <div class="modal-header">
      <div id="shareModalTitle">Share</div>
      <button class="modal-close-btn" onclick="closeBottomModal('share')">Close</button>
    </div>
    <div id="shareModalBody" class="modal-body"></div>
  </div>

  <!-- PIP self video -->
  <div id="selfPIP" class="self-video-pip" aria-label="Your video" style="display:none"></div>

  <!-- Loading and error states -->
  <div id="loading">Joining meeting...</div>
  <div id="error">
    <div>
      <h2>Unable to Join Meeting</h2>
      <p id="errorMessage"></p>
      <button class="retry-btn" onclick="retryJoin()">Try Again</button>
    </div>
  </div>

<script>
// Simplified and improved version
const params = new URLSearchParams(window.location.search);
const meetingNumber = params.get("meetingNumber");
const signature = decodeURIComponent(params.get("signature") || "");
const sdkKey = params.get("sdkKey");
const userName = decodeURIComponent(params.get("name") || "Guest");
const password = decodeURIComponent(params.get("password") || "").trim();

let zoomClient = null;
let hasJoined = false;
let tileMap = new Map();
let thumbnailHideTimer = null;

// Initialize on load
window.addEventListener('DOMContentLoaded', startMeeting);

async function startMeeting() {
  try {
    if (!meetingNumber || !signature || !sdkKey) {
      throw new Error('Missing meeting parameters');
    }

    document.getElementById('loading').style.display = 'flex';
    
    // Initialize Zoom client
    zoomClient = window.ZoomMtgEmbedded.createClient();
    
    await zoomClient.init({
      zoomAppRoot: document.getElementById('meetingSDKElement'),
      language: 'en-US',
      patchJsMedia: true
    });

    // Set up event listeners
    zoomClient.on('connection-change', (payload) => {
      console.log('Connection state:', payload.state);
      if (payload.state === 'Connected') {
        hasJoined = true;
        document.getElementById('loading').style.display = 'none';
        startUIUpdates();
      } else if (payload.state === 'Closed') {
        handleMeetingEnd();
      }
    });

    // Join meeting
    await zoomClient.join({
      sdkKey: sdkKey,
      signature: signature,
      meetingNumber: meetingNumber,
      password: password,
      userName: userName
    });

    // Set up control button listeners
    setupControlButtons();

  } catch (error) {
    console.error('Failed to start meeting:', error);
    showError(error.message || 'Failed to join meeting');
  }
}

function setupControlButtons() {
  // Use the SDK's built-in controls instead of complex interception
  const sdkRoot = document.getElementById('meetingSDKElement');
  
  // Just add click handlers to our custom buttons that trigger the SDK buttons
  document.getElementById('chatBtn').onclick = () => triggerSDKButton('Chat');
  document.getElementById('participantsBtn').onclick = () => triggerSDKButton('Participants');
  document.getElementById('shareBtn').onclick = () => triggerSDKButton('Share Screen');
  document.getElementById('settingsBtn').onclick = () => triggerSDKButton('Settings');
  document.getElementById('leaveBtn').onclick = () => triggerSDKButton('Leave');
}

function triggerSDKButton(buttonLabel) {
  const sdkRoot = document.getElementById('meetingSDKElement');
  const buttons = sdkRoot.querySelectorAll('button');
  
  for (const button of buttons) {
    const label = button.getAttribute('aria-label') || button.textContent;
    if (label && label.includes(buttonLabel)) {
      button.click();
      showThumbnailsTemporarily();
      return;
    }
  }
  
  // Fallback for leave
  if (buttonLabel === 'Leave') {
    zoomClient.leave();
  }
}

function startUIUpdates() {
  // Start observing for participant changes
  setInterval(updateThumbnails, 2000);
  startThumbnailAutoHide();
  
  // Add activity listeners to show thumbnails
  ['mousemove', 'touchstart', 'click'].forEach(event => {
    document.addEventListener(event, showThumbnailsTemporarily, { passive: true });
  });
}

function updateThumbnails() {
  if (!hasJoined) return;
  
  const sdkRoot = document.getElementById('meetingSDKElement');
  const videoContainers = sdkRoot.querySelectorAll('[class*="video-container"], li.zoom-MuiListItem-root');
  
  // Simple thumbnail management - just show/hide based on participants
  const thumbnailBar = document.getElementById('thumbnailBar');
  
  if (videoContainers.length > 1) {
    // Multiple participants - show thumbnails
    buildSimpleThumbnails(videoContainers);
    document.getElementById('selfPIP').style.display = 'none';
  } else {
    // Single participant - show PIP
    thumbnailBar.innerHTML = '';
    setupSelfPIP();
  }
}

function buildSimpleThumbnails(containers) {
  const thumbnailBar = document.getElementById('thumbnailBar');
  thumbnailBar.innerHTML = '';
  
  containers.forEach((container, index) => {
    const video = container.querySelector('video');
    if (!video) return;
    
    const thumb = document.createElement('div');
    thumb.className = 'thumbnail';
    thumb.innerHTML = `
      <video autoplay muted playsinline></video>
      <div class="thumb-name">Participant ${index + 1}</div>
    `;
    
    // Try to use the video stream
    try {
      if (video.srcObject) {
        thumb.querySelector('video').srcObject = video.srcObject;
      }
    } catch (e) {
      // Ignore - we'll show placeholder
    }
    
    thumb.onclick = () => {
      // Simple main view switching
      showInMainView(container);
      showThumbnailsTemporarily();
    };
    
    thumbnailBar.appendChild(thumb);
  });
}

function showInMainView(container) {
  const mainContainer = document.getElementById('mainVideoContainer');
  const video = container.querySelector('video');
  
  if (video) {
    mainContainer.innerHTML = '';
    const mainVideo = document.createElement('video');
    mainVideo.autoplay = true;
    mainVideo.playsInline = true;
    mainVideo.style.width = '100%';
    mainVideo.style.height = '100%';
    mainVideo.style.objectFit = 'contain';
    
    try {
      if (video.srcObject) {
        mainVideo.srcObject = video.srcObject;
      }
    } catch (e) {
      console.warn('Could not set main video source');
    }
    
    mainContainer.appendChild(mainVideo);
  }
}

function setupSelfPIP() {
  const sdkRoot = document.getElementById('meetingSDKElement');
  const selfVideo = sdkRoot.querySelector('video[id*="SELF"]') || sdkRoot.querySelector('video');
  
  if (selfVideo) {
    const pip = document.getElementById('selfPIP');
    pip.style.display = 'block';
    pip.innerHTML = '<video autoplay muted playsinline></video>';
    
    try {
      if (selfVideo.srcObject) {
        pip.querySelector('video').srcObject = selfVideo.srcObject;
      }
    } catch (e) {
      // Ignore
    }
  }
}

// Thumbnail auto-hide functionality
function startThumbnailAutoHide() {
  resetThumbnailHideTimer();
}

function resetThumbnailHideTimer() {
  clearTimeout(thumbnailHideTimer);
  thumbnailHideTimer = setTimeout(() => {
    document.getElementById('thumbnailBar').classList.add('hidden');
  }, 3000);
}

function showThumbnailsTemporarily() {
  const thumbnailBar = document.getElementById('thumbnailBar');
  if (thumbnailBar.children.length > 0) {
    thumbnailBar.classList.remove('hidden');
    resetThumbnailHideTimer();
  }
}

// Modal functions
function openBottomModal(kind) {
  document.getElementById(kind + 'Modal').classList.add('open');
  document.getElementById(kind + 'Modal').setAttribute('aria-hidden', 'false');
}

function closeBottomModal(kind) {
  document.getElementById(kind + 'Modal').classList.remove('open');
  document.getElementById(kind + 'Modal').setAttribute('aria-hidden', 'true');
}

// Error handling
function showError(message) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('error').style.display = 'flex';
}

function retryJoin() {
  document.getElementById('error').style.display = 'none';
  startMeeting();
}

function handleMeetingEnd() {
  if (window.ReactNativeWebView) {
    window.ReactNativeWebView.postMessage(JSON.stringify({ action: 'meetingEnded' }));
  } else {
    alert('Meeting has ended');
  }
}
</script>
</body>
</html>