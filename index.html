<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>Zoom Meeting</title>

    <!-- Zoom SDK Dependencies -->
    <script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>

    <style>
      :root {
        --bg-color: #0a0a0a;
        --accent: #007bff;
        --text: #ffffff;
        --error: #ff4d4d;
      }

      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text);
        font-family: "Inter", sans-serif;
        overflow: hidden;
      }

      #meetingContainer {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
      }

      #headerBar {
        height: 50px;
        background-color: rgba(20, 20, 20, 0.95);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 2;
      }

      #headerBar h1 {
        font-size: 16px;
        font-weight: 500;
        margin: 0;
      }

      #leaveButton {
        background: var(--accent);
        border: none;
        color: white;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
      }

      #leaveButton:hover {
        background: #0062cc;
      }

      #meetingSDKElement {
        flex: 1;
        width: 100%;
        height: calc(100vh - 50px);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #loadingOverlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.85);
        color: var(--text);
        font-size: 18px;
        z-index: 5;
      }

      #error {
        text-align: center;
        color: var(--error);
        margin-top: 15px;
      }

      @media (max-width: 600px) {
        #headerBar h1 {
          font-size: 14px;
        }
        #leaveButton {
          padding: 6px 12px;
          font-size: 13px;
        }
      }
    </style>
  </head>

  <body>
    <div id="meetingContainer">
      <div id="headerBar">
        <h1>Zoom Meeting</h1>
        <button id="leaveButton">Leave Meeting</button>
      </div>

      <div id="meetingSDKElement"></div>
      <div id="loadingOverlay">Connecting to meeting...</div>
      <div id="error"></div>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const meetingNumber = params.get("meetingNumber");
        const signature = decodeURIComponent(params.get("signature") || "");
        const sdkKey = params.get("sdkKey");
        const userName = decodeURIComponent(params.get("name") || "Guest");
        const password = decodeURIComponent(params.get("password") || "").trim();

        const errorBox = document.getElementById("error");
        const loading = document.getElementById("loadingOverlay");
        const leaveBtn = document.getElementById("leaveButton");

        if (!meetingNumber || !signature || !sdkKey) {
          errorBox.innerText = "❌ Missing required parameters.";
          loading.style.display = "none";
          return;
        }

        try {
          const client = window.ZoomMtgEmbedded.createClient();
          const meetingSDKElement = document.getElementById("meetingSDKElement");

          // Initialize SDK
          await client.init({
            zoomAppRoot: meetingSDKElement,
            language: "en-US",
            customize: {
              video: { isResizable: true, viewSizes: { default: { width: "100%", height: "100%" } } },
              chat: { popper: { disableDraggable: true } },
            },
          });

          // Join meeting
          await client.join({
            sdkKey,
            signature,
            meetingNumber,
            password,
            userName,
          });

          console.log("✅ Joined meeting successfully!");
          loading.style.display = "none";

          // Leave Meeting Handler
          leaveBtn.onclick = async () => {
            await client.leave();
            notifyAppAndClose();
          };

          // Listen for meeting end event
          client.on("connection-change", (payload) => {
            if (payload.state === "Closed") {
              notifyAppAndClose();
            }
          });
        } catch (err) {
          console.error("❌ Join error:", err);
          errorBox.innerText = "❌ Failed to join meeting. See console.";
          loading.style.display = "none";
        }

        // Notify your React Native app via postMessage
        function notifyAppAndClose() {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(
              JSON.stringify({ action: "exitMeeting" })
            );
          } else {
            alert("Meeting ended. You can now close this window.");
          }
        }
      });
    </script>
  </body>
</html>
