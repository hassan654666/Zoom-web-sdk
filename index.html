<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Zoom Meeting - Auto Join Fullscreen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Zoom Meeting Embedded SDK v4.0.0 -->
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/zoom-meeting-embedded-4.0.0.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background-color: #000;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #meetingContainer {
        flex: 1;
        width: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        background: #252525;
        overflow: hidden;
      }

      #meetingSDKElement {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      video {
        aspect-ratio: 16 / 9;
        object-fit: cover;
        border-radius: 8px;
        display: block;
      }

      video::-webkit-media-controls-enclosure {
        overflow: visible !important;
      }

      /* Hide Meeting Info (top-left ‚Äúi‚Äù icon) */
      button[aria-label="Meeting Information"],
      .zm-header--meeting-info {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
      }

      /* --- Dedicated bottom popper container --- */
      /* #bottomPanel {
        width: 100%;
        height: 30vh;
        max-height: 300px;
        background: rgba(20, 20, 20, 0.98);
        position: absolute;
        bottom: 0;
        overflow-y: auto; */
       /* display: none; /* shown dynamically */
        /* z-index: 9999;
      } */

      /* LEFT panel for poppers (chat/participants/settings/etc.) */
      /* #leftPanel {
        width: 360px;            /* adjust to taste, mobile: use smaller width */
        /* max-width: 40%;
        min-width: 260px;
        height: 100vh;
        background: rgba(12,12,12,0.98);
        border-right: 1px solid rgba(255,255,255,0.03);
        box-sizing: border-box;
        z-index: 10000; */
        /*display: none; /* start hidden; shown when popper opens */
        /* overflow-y: auto;
        -webkit-overflow-scrolling: touch; */
      /*} */

      /* Ensure poppers render correctly into bottomPanel */
      /* .zm-popover-content,
      .zm-dialog,
      .zm-modal,
      .zm-modal-content,
      .ReactModal__Content {
        position: relative !important;
        /* top: 0 !important;
        left: 0 !important;
        right: 0 !important; */
        /* bottom: 0 !important;
        max-width: 100% !important;
        width: 100% !important; */
        /* height: 100% !important; */
        /* border-radius: 0 !important; */
      /* } */ 

      /* Fix for overflow UI in landscape mode */
      /* @media (orientation: landscape) {
        #meetingSDKElement {
          height: 90vh !important;
        }
        #bottomPanel {
          height: 10vh !important;
          max-height: 120px;
        }
      } */

      /* Gallery pagination arrows always visible */
      /* .zm-gallery-view .zm-gallery-page-btn {
        opacity: 1 !important;
        visibility: visible !important;
      }

      .zm-gallery-page-btn {
        z-index: 10000 !important;
      } */
    </style>
  </head>

  <body>
    <div id="meetingContainer">
      <div id="meetingSDKElement"></div>
      <div id="bottomPanel"></div>
      <!-- <div id="bottomPanel"></div> -->
    </div>

    <script>
      (async () => {
        const meetingSDKElement = document.getElementById("meetingSDKElement");
        const bottomPanel = document.getElementById("bottomPanel");
        // const leftPanel = document.getElementById("leftPanel");
        const client = ZoomMtgEmbedded.createClient();

        // --- Credentials (replace with actual) ---
        const params = new URLSearchParams(window.location.search);
        const meetingNumber = params.get("meetingNumber");
        const signature = decodeURIComponent(params.get("signature") || "");
        const sdkKey = params.get("sdkKey");
        const userName = decodeURIComponent(params.get("name") || "Guest");
        const password = decodeURIComponent(params.get("password") || "").trim();

        try {
          await client.init({
            zoomAppRoot: meetingSDKElement,
            language: "en-US",
            maximumVideosInGalleryView: 1,
            customize: {
              // meeting: {
              //   popper: {
              //     placement: "top",
              //     disableDraggable: true,
              //     anchorElement: meetingSDKElement,
              //   },
              // },
              video: {
                isResizable: false,
                showPipButton: true,
                defaultViewType: 'ribbon',
                // popper: {
                //   anchorElement: bottomPanel,
                //   placement: 'bottom',
                //   disableDraggable: true,
                //   disablePortal: true,
                //   offset: { mainAxis: 12 },
                //   disableHideOnClickOutside: false
                // },
                viewSizes: {
                  default: {
                    width: window.innerWidth * 0.8,
                    height: window.innerHeight * 0.92,
                  },
                  ribbon: {
                    width: window.innerWidth * 1,
                    height: window.innerHeight * 0.9,
                  },
                },
              },
              chat: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              participants: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              setting: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              reactions: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              captionSettings: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              activeApps: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              // meetingInfo: {
              //   popper: {
              //     placement: "bottom",
              //     disableDraggable: true,
              //     anchorElement: bottomPanel,
              //   },
              // },
              toolbar: {
                buttons: [
                  "microphone",
                  "camera",
                  "participants",
                  "chat",
                  // "share",
                  // "whiteboard",
                  // "recording",
                  "settings",
                  "leave",
                ],
              }
            },
          });

          await client.join({
            signature: signature,
            sdkKey: sdkKey,
            meetingNumber: meetingNumber,
            password: password,
            userName: userName,
          });

          console.log("‚úÖ Joined meeting automatically!");

          const forceBottomPanelPlacement = () => {
            const poppers = document.querySelectorAll('.zm-popover-content, .zm-modal');
            poppers.forEach(p => {
              if (!bottomPanel.contains(p)) bottomPanel.appendChild(p);
            });
          };

          const observer = new MutationObserver(forceBottomPanelPlacement);
          observer.observe(document.body, { childList: true, subtree: true });


          // --- Meeting End Notification ---
          client.on("connection-change", (payload) => {
            if (payload.state === "Closed") {
              console.log("üì© Meeting ended, notifying app...");
              if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({ action: "meetingEnded" })
                );
              } else {
                console.log("‚ö†Ô∏è ReactNativeWebView not found");
              }
            }
          });

          // --- Dynamic Resize Handler ---
          const handleResize = () => {
            const width = window.innerWidth;
            const height = window.innerHeight;

            client.updateVideoOptions({
              viewSizes: {
                default: { width: width * 0.8, height: height * 0.92 },
                ribbon: { width: width * 1, height: height * 0.9 },
              },
            });

            console.log("üì± Rotated/resized:", width, "x", height);
          };

          window.addEventListener("resize", handleResize);
          handleResize();

          // --- Manual PIP enable fallback ---
          function enablePiP() {
            const video = document.querySelector('video');
            if (video && document.pictureInPictureEnabled && !document.pictureInPictureElement) {
              video.requestPictureInPicture().catch(err => console.warn('PiP failed:', err));
            }
          }

          // optional: expose for React Native
          window.enablePiP = enablePiP;

          // optional: auto-enable PiP when app backgrounds
          document.addEventListener('visibilitychange', () => {
            if (document.hidden) enablePiP();
          });

          setTimeout(() => {
            document
              .querySelectorAll('button[aria-label="Meeting Information"]')
              .forEach(btn => (btn.style.display = 'none'));
          }, 2000);

          // window.addEventListener("orientationchange", handleOrientationChange);
          // window.addEventListener("resize", handleOrientationChange);

          // function handleOrientationChange() {
          //   console.log("Orientation:", screen.orientation.type);
          //   restartCamera();
          // }

        } catch (error) {
          console.error("‚ùå Error joining meeting:", error);
        }
      })();
    </script>
  </body>
</html>
