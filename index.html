<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Zoom Meeting (Embedded)</title>

  <!-- Zoom Embedded SDK -->
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>

  <style>
    /* --- Reset and base styles --- */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      touch-action: manipulation;
    }

    /* --- Main layout container --- */
    #meetingContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #000;
    }

    /* --- Video area --- */
    #mainVideoContainer {
      flex: 1;
      background: #000;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
      overflow: hidden;
    }

    /* --- SDK container --- */
    #meetingSDKElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      z-index: 1;
    }

    /* --- Thumbnail bar --- */
    #thumbnailBar {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      height: 90px;
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%);
      display: flex;
      align-items: center;
      padding: 8px 12px;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      z-index: 100;
      transition: opacity 0.3s ease, transform 0.3s ease;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    #thumbnailBar::-webkit-scrollbar {
      display: none;
    }

    #thumbnailBar.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }

    .thumbnail {
      flex: 0 0 auto;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      background: #111;
      border: 2px solid transparent;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    .thumbnail.active {
      border-color: #2D8CFF;
    }

    .thumbnail video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .thumbnail .thumb-name {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- Bottom modals --- */
    .bottom-modal {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: min(70%, 500px);
      background: rgba(20,20,20,0.98);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      backdrop-filter: blur(20px);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      overflow: hidden;
    }

    .bottom-modal.open {
      transform: translateY(0);
    }

    .bottom-modal .modal-header {
      padding: 16px 20px;
      color: #fff;
      font-weight: 600;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }

    .bottom-modal .modal-body {
      flex: 1;
      overflow: auto;
      padding: 16px 20px;
      background: transparent;
      color: #fff;
      width: 100%;
      height: 100%;
    }

    .modal-close-btn {
      background: #2D8CFF;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      min-width: 60px;
      min-height: 36px;
    }

    /* --- Stacked tiles fallback --- */
    .stacked-tiles {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px;
      overflow: auto;
      height: 100%;
      width: 100%;
    }

    .stacked-tiles .stacked-tile {
      background: #0b0b0b;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.03);
      min-height: 120px;
      display: flex;
      flex-direction: column;
    }

    .stacked-tile .tile-name {
      color: #fff;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stacked-tile .tile-video {
      flex: 1;
      background: #000;
      border-radius: 4px;
      overflow: hidden;
    }

    .stacked-tile .tile-video video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* --- Loading and error states --- */
    #loading, #error {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 10000;
      background: #000;
    }

    #error {
      display: none;
      text-align: center;
      padding: 20px;
    }

    #error h2 {
      margin-bottom: 16px;
      font-size: 20px;
    }

    #error p {
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .retry-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: #2D8CFF;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      min-width: 120px;
      min-height: 44px;
    }

    /* --- Responsive design --- */
    @media (max-width: 640px) {
      .thumbnail {
        width: 70px;
        height: 70px;
      }
      
      #thumbnailBar {
        bottom: 65px;
        height: 80px;
      }
      
      .bottom-modal {
        height: min(80%, 500px);
      }
    }

    @media (max-width: 480px) {
      .thumbnail {
        width: 60px;
        height: 60px;
      }
      
      #thumbnailBar {
        bottom: 60px;
        height: 75px;
      }
    }

    /* --- Zoom toolbar styling --- */
    .zoom-toolbar-container {
      position: fixed !important;
      bottom: 8px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      z-index: 200 !important;
      display: flex !important;
      gap: 8px !important;
      align-items: center !important;
      padding: 8px 12px !important;
      border-radius: 12px !important;
      max-width: 95vw !important;
      overflow: hidden !important;
      background: rgba(0,0,0,0.7) !important;
      backdrop-filter: blur(10px) !important;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5) !important;
      flex-wrap: wrap !important;
      justify-content: center !important;
    }

    /* Ensure all toolbar buttons are visible */
    .zoom-MuiButton-root {
      min-width: 32px !important;
      min-height: 32px !important;
      padding: 4px !important;
      margin: 0 2px !important;
    }
  </style>
</head>
<body>
  <div id="meetingContainer">
    <div id="mainVideoContainer">
      <!-- Main video will be placed here -->
    </div>
    <div id="meetingSDKElement"></div>
  </div>

  <!-- Thumbnails strip -->
  <div id="thumbnailBar" aria-label="Participant thumbnails"></div>

  <!-- Bottom modals -->
  <div id="chatModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="chatModalTitle">
    <div class="modal-header">
      <div id="chatModalTitle">Chat</div>
      <button class="modal-close-btn" onclick="closeBottomModal('chat')">Close</button>
    </div>
    <div id="chatModalBody" class="modal-body"></div>
  </div>

  <div id="participantsModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="participantsModalTitle">
    <div class="modal-header">
      <div id="participantsModalTitle">Participants</div>
      <button class="modal-close-btn" onclick="closeBottomModal('participants')">Close</button>
    </div>
    <div id="participantsModalBody" class="modal-body"></div>
  </div>

  <div id="settingsModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="settingsModalTitle">
    <div class="modal-header">
      <div id="settingsModalTitle">Settings</div>
      <button class="modal-close-btn" onclick="closeBottomModal('settings')">Close</button>
    </div>
    <div id="settingsModalBody" class="modal-body"></div>
  </div>

  <div id="shareModal" class="bottom-modal" aria-hidden="true" role="dialog" aria-labelledby="shareModalTitle">
    <div class="modal-header">
      <div id="shareModalTitle">Share</div>
      <button class="modal-close-btn" onclick="closeBottomModal('share')">Close</button>
    </div>
    <div id="shareModalBody" class="modal-body"></div>
  </div>

  <!-- Loading and error states -->
  <div id="loading">Joining meeting...</div>
  <div id="error">
    <div>
      <h2>Unable to Join Meeting</h2>
      <p id="errorMessage"></p>
      <button class="retry-btn" onclick="retryJoin()">Try Again</button>
    </div>
  </div>

<script>
// Configuration and state
const params = new URLSearchParams(window.location.search);
const meetingNumber = params.get("meetingNumber");
const signature = decodeURIComponent(params.get("signature") || "");
const sdkKey = params.get("sdkKey");
const userName = decodeURIComponent(params.get("name") || "Guest");
const password = decodeURIComponent(params.get("password") || "").trim();

let zoomClient = null;
let hasJoined = false;
let tileMap = new Map();
let thumbnailHideTimer = null;
let currentMainTileId = null;
let isThumbnailMode = false;

// Initialize on load
window.addEventListener('DOMContentLoaded', startMeeting);

async function startMeeting() {
  try {
    if (!meetingNumber || !signature || !sdkKey) {
      throw new Error('Missing meeting parameters');
    }

    document.getElementById('loading').style.display = 'flex';
    
    // Initialize Zoom client
    zoomClient = window.ZoomMtgEmbedded.createClient();
    
    await zoomClient.init({
      zoomAppRoot: document.getElementById('meetingSDKElement'),
      language: 'en-US',
      patchJsMedia: true
    });

    // Set up event listeners
    zoomClient.on('connection-change', (payload) => {
      console.log('Connection state:', payload.state);
      if (payload.state === 'Connected') {
        hasJoined = true;
        document.getElementById('loading').style.display = 'none';
        startUIUpdates();
      } else if (payload.state === 'Closed') {
        handleMeetingEnd();
      }
    });

    // Join meeting
    await zoomClient.join({
      sdkKey: sdkKey,
      signature: signature,
      meetingNumber: meetingNumber,
      password: password,
      userName: userName
    });

    // Set up toolbar styling and modal interception
    setupToolbarAndModals();

  } catch (error) {
    console.error('Failed to start meeting:', error);
    showError(error.message || 'Failed to join meeting');
  }
}

function setupToolbarAndModals() {
  const sdkRoot = document.getElementById('meetingSDKElement');
  
  // Style the toolbar to fit the screen
  const styleToolbar = () => {
    const toolbars = sdkRoot.querySelectorAll('[class*="toolbar"], [class*="footer"], [class*="control-bar"]');
    toolbars.forEach(toolbar => {
      if (toolbar.querySelector('button')) {
        toolbar.classList.add('zoom-toolbar-container');
      }
    });
  };
  
  // Intercept button clicks to open modals instead of default behavior
  const interceptButtonClicks = () => {
    sdkRoot.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) return;
      
      const ariaLabel = button.getAttribute('aria-label') || '';
      const title = button.getAttribute('title') || '';
      
      // Prevent default behavior and open our modal
      if (ariaLabel.includes('Chat') || title.includes('Chat')) {
        event.preventDefault();
        event.stopPropagation();
        openZoomPanelInModal('chat');
      } else if (ariaLabel.includes('Participant') || title.includes('Participant')) {
        event.preventDefault();
        event.stopPropagation();
        openZoomPanelInModal('participants');
      } else if (ariaLabel.includes('Share') || title.includes('Share')) {
        event.preventDefault();
        event.stopPropagation();
        openZoomPanelInModal('share');
      } else if (ariaLabel.includes('Setting') || title.includes('Setting')) {
        event.preventDefault();
        event.stopPropagation();
        openZoomPanelInModal('settings');
      } else if (ariaLabel.includes('Leave') || title.includes('Leave')) {
        // Let leave button work normally but ensure we handle the meeting end
        setTimeout(() => {
          if (!hasJoined) {
            handleMeetingEnd();
          }
        }, 1000);
      }
    }, true);
  };
  
  // Apply initial styling and set up observer for dynamic changes
  styleToolbar();
  interceptButtonClicks();
  
  const observer = new MutationObserver(() => {
    styleToolbar();
  });
  
  observer.observe(sdkRoot, {
    childList: true,
    subtree: true
  });
}

function openZoomPanelInModal(panelType) {
  const sdkRoot = document.getElementById('meetingSDKElement');
  
  // First, try to find an existing panel
  let panel = findZoomPanel(panelType);
  
  if (panel) {
    // Move the panel to our modal
    movePanelToModal(panelType, panel);
  } else {
    // If no panel found, trigger the button click to create one
    const button = findToolbarButton(panelType);
    if (button) {
      button.click();
      
      // Wait for panel to appear and then move it
      setTimeout(() => {
        panel = findZoomPanel(panelType);
        if (panel) {
          movePanelToModal(panelType, panel);
        }
      }, 500);
    }
  }
}

function findZoomPanel(panelType) {
  const sdkRoot = document.getElementById('meetingSDKElement');
  const keyword = panelType.toLowerCase();
  
  // Look for dialog elements with relevant content
  const dialogs = sdkRoot.querySelectorAll('[role="dialog"]');
  
  for (const dialog of dialogs) {
    const text = dialog.textContent.toLowerCase();
    const ariaLabel = dialog.getAttribute('aria-label') || '';
    
    if (text.includes(keyword) || ariaLabel.toLowerCase().includes(keyword)) {
      return dialog;
    }
  }
  
  // Also check for panels that might not have role="dialog"
  const panels = sdkRoot.querySelectorAll('[class*="panel"], [class*="drawer"], [class*="menu"]');
  
  for (const panel of panels) {
    const text = panel.textContent.toLowerCase();
    if (text.includes(keyword)) {
      return panel;
    }
  }
  
  return null;
}

function findToolbarButton(buttonType) {
  const sdkRoot = document.getElementById('meetingSDKElement');
  const keyword = buttonType.toLowerCase();
  const buttons = sdkRoot.querySelectorAll('button');
  
  for (const button of buttons) {
    const ariaLabel = button.getAttribute('aria-label') || '';
    const title = button.getAttribute('title') || '';
    
    if (ariaLabel.toLowerCase().includes(keyword) || title.toLowerCase().includes(keyword)) {
      return button;
    }
  }
  
  return null;
}

function movePanelToModal(panelType, panel) {
  const modalBody = document.getElementById(panelType + 'ModalBody');
  
  if (!modalBody) return;
  
  // Clear previous content
  modalBody.innerHTML = '';
  
  // Move the panel to the modal
  modalBody.appendChild(panel);
  
  // Open the modal
  openBottomModal(panelType);
  
  // Ensure the panel is styled correctly for the modal
  panel.style.width = '100%';
  panel.style.height = '100%';
  panel.style.overflow = 'auto';
}

function openBottomModal(kind) {
  document.getElementById(kind + 'Modal').classList.add('open');
  document.getElementById(kind + 'Modal').setAttribute('aria-hidden', 'false');
}

function closeBottomModal(kind) {
  document.getElementById(kind + 'Modal').classList.remove('open');
  document.getElementById(kind + 'Modal').setAttribute('aria-hidden', 'true');
  
  // Return the panel to the SDK root if needed
  const modalBody = document.getElementById(kind + 'ModalBody');
  const panel = modalBody.querySelector('[role="dialog"], [class*="panel"]');
  
  if (panel) {
    modalBody.removeChild(panel);
    document.getElementById('meetingSDKElement').appendChild(panel);
  }
}

function startUIUpdates() {
  // Start monitoring for participant changes
  setInterval(updateParticipantTiles, 2000);
  startThumbnailAutoHide();
  
  // Add activity listeners to show thumbnails
  ['mousemove', 'touchstart', 'click'].forEach(event => {
    document.addEventListener(event, showThumbnailsTemporarily, { passive: true });
  });
}

function updateParticipantTiles() {
  if (!hasJoined) return;
  
  const sdkRoot = document.getElementById('meetingSDKElement');
  const videoContainers = sdkRoot.querySelectorAll('li.zoom-MuiListItem-root, [class*="video-container"]');
  
  if (videoContainers.length > 0) {
    // We have gallery view - build thumbnails
    buildThumbnailView(videoContainers);
    isThumbnailMode = true;
  } else {
    // Fallback to stacked view
    buildStackedView();
    isThumbnailMode = false;
  }
}

function buildThumbnailView(containers) {
  const thumbnailBar = document.getElementById('thumbnailBar');
  const mainContainer = document.getElementById('mainVideoContainer');
  
  // Clear previous content
  thumbnailBar.innerHTML = '';
  tileMap.clear();
  
  // Process each container
  const tileData = [];
  
  containers.forEach((container, index) => {
    const video = container.querySelector('video');
    const nameElement = container.querySelector('.zoom-MuiTypography-noWrap');
    const name = nameElement ? nameElement.textContent : `Participant ${index + 1}`;
    
    const isSelf = name.toLowerCase().includes(userName.toLowerCase()) || 
                  (video && video.id === 'ZOOM_WEB_SDK_SELF_VIDEO');
    
    const tileId = `tile-${index}`;
    
    tileData.push({
      id: tileId,
      container,
      video,
      name,
      isSelf
    });
    
    tileMap.set(tileId, { container, video, name, isSelf });
  });
  
  // Sort to put self first
  tileData.sort((a, b) => {
    if (a.isSelf && !b.isSelf) return -1;
    if (!a.isSelf && b.isSelf) return 1;
    return 0;
  });
  
  // Create thumbnails
  tileData.forEach((tile, index) => {
    const thumb = document.createElement('div');
    thumb.className = 'thumbnail';
    thumb.id = `thumb-${tile.id}`;
    
    if (index === 0) {
      thumb.classList.add('active');
      currentMainTileId = tile.id;
      showTileInMainView(tile);
    }
    
    // Create video element for thumbnail
    if (tile.video) {
      const thumbVideo = document.createElement('video');
      thumbVideo.autoplay = true;
      thumbVideo.muted = true;
      thumbVideo.playsInline = true;
      thumbVideo.style.width = '100%';
      thumbVideo.style.height = '100%';
      thumbVideo.style.objectFit = 'cover';
      
      try {
        if (tile.video.srcObject) {
          thumbVideo.srcObject = tile.video.srcObject;
        }
      } catch (e) {
        // Ignore errors
      }
      
      thumb.appendChild(thumbVideo);
    } else {
      // Placeholder for video
      const placeholder = document.createElement('div');
      placeholder.style.width = '100%';
      placeholder.style.height = '100%';
      placeholder.style.background = '#222';
      placeholder.style.display = 'flex';
      placeholder.style.alignItems = 'center';
      placeholder.style.justifyContent = 'center';
      placeholder.style.color = '#fff';
      placeholder.style.fontSize = '12px';
      placeholder.textContent = 'No Video';
      thumb.appendChild(placeholder);
    }
    
    // Add name overlay
    const nameDiv = document.createElement('div');
    nameDiv.className = 'thumb-name';
    nameDiv.textContent = tile.name;
    thumb.appendChild(nameDiv);
    
    // Add click handler
    thumb.onclick = () => {
      // Update active state
      document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');
      
      // Show in main view
      showTileInMainView(tile);
      currentMainTileId = tile.id;
      
      // Reset thumbnail hide timer
      showThumbnailsTemporarily();
    };
    
    thumbnailBar.appendChild(thumb);
  });
  
  // Show the thumbnail bar
  thumbnailBar.classList.remove('hidden');
}

function buildStackedView() {
  const mainContainer = document.getElementById('mainVideoContainer');
  const thumbnailBar = document.getElementById('thumbnailBar');
  
  // Hide thumbnail bar
  thumbnailBar.classList.add('hidden');
  
  // Clear main container
  mainContainer.innerHTML = '';
  
  // Create stacked view
  const stackedContainer = document.createElement('div');
  stackedContainer.className = 'stacked-tiles';
  
  // Use canvas if available (gallery view)
  const canvas = document.getElementById('zoom-sdk-video-canvas');
  if (canvas) {
    const canvasContainer = document.createElement('div');
    canvasContainer.className = 'stacked-tile';
    canvasContainer.style.flex = '1';
    
    const canvasClone = canvas.cloneNode(true);
    canvasClone.style.width = '100%';
    canvasClone.style.height = '100%';
    
    canvasContainer.appendChild(canvasClone);
    stackedContainer.appendChild(canvasContainer);
  } else {
    // Fallback: show message
    const message = document.createElement('div');
    message.style.color = '#fff';
    message.style.textAlign = 'center';
    message.style.padding = '20px';
    message.textContent = 'Waiting for participants...';
    stackedContainer.appendChild(message);
  }
  
  mainContainer.appendChild(stackedContainer);
}

function showTileInMainView(tile) {
  const mainContainer = document.getElementById('mainVideoContainer');
  
  // Clear main container
  mainContainer.innerHTML = '';
  
  if (tile.video) {
    const mainVideo = document.createElement('video');
    mainVideo.autoplay = true;
    mainVideo.playsInline = true;
    mainVideo.style.width = '100%';
    mainVideo.style.height = '100%';
    mainVideo.style.objectFit = 'contain';
    
    try {
      if (tile.video.srcObject) {
        mainVideo.srcObject = tile.video.srcObject;
      }
    } catch (e) {
      console.warn('Could not set main video source');
    }
    
    // Add name overlay
    const nameOverlay = document.createElement('div');
    nameOverlay.style.position = 'absolute';
    nameOverlay.style.bottom = '12px';
    nameOverlay.style.left = '12px';
    nameOverlay.style.background = 'rgba(0,0,0,0.7)';
    nameOverlay.style.color = '#fff';
    nameOverlay.style.padding = '6px 12px';
    nameOverlay.style.borderRadius = '4px';
    nameOverlay.style.fontSize = '14px';
    nameOverlay.textContent = tile.name;
    
    mainContainer.appendChild(mainVideo);
    mainContainer.appendChild(nameOverlay);
  } else {
    // Show placeholder
    const placeholder = document.createElement('div');
    placeholder.style.width = '100%';
    placeholder.style.height = '100%';
    placeholder.style.background = '#000';
    placeholder.style.display = 'flex';
    placeholder.style.flexDirection = 'column';
    placeholder.style.alignItems = 'center';
    placeholder.style.justifyContent = 'center';
    placeholder.style.color = '#fff';
    
    const icon = document.createElement('div');
    icon.style.fontSize = '48px';
    icon.style.marginBottom = '16px';
    icon.textContent = 'ðŸ‘¤';
    
    const name = document.createElement('div');
    name.style.fontSize = '18px';
    name.textContent = tile.name;
    
    placeholder.appendChild(icon);
    placeholder.appendChild(name);
    mainContainer.appendChild(placeholder);
  }
}

// Thumbnail auto-hide functionality
function startThumbnailAutoHide() {
  resetThumbnailHideTimer();
}

function resetThumbnailHideTimer() {
  clearTimeout(thumbnailHideTimer);
  thumbnailHideTimer = setTimeout(() => {
    if (isThumbnailMode) {
      document.getElementById('thumbnailBar').classList.add('hidden');
    }
  }, 30000); // 30 seconds
}

function showThumbnailsTemporarily() {
  if (isThumbnailMode) {
    document.getElementById('thumbnailBar').classList.remove('hidden');
    resetThumbnailHideTimer();
  }
}

// Error handling
function showError(message) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('error').style.display = 'flex';
}

function retryJoin() {
  document.getElementById('error').style.display = 'none';
  document.getElementById('loading').style.display = 'flex';
  
  // Reset state
  hasJoined = false;
  tileMap.clear();
  
  // Restart meeting
  setTimeout(() => {
    startMeeting();
  }, 1000);
}

function handleMeetingEnd() {
  hasJoined = false;
  
  // Notify React Native app
  if (window.ReactNativeWebView) {
    window.ReactNativeWebView.postMessage(JSON.stringify({ 
      action: 'meetingEnded',
      meetingNumber: meetingNumber
    }));
  }
  
  // Show ended message
  const mainContainer = document.getElementById('mainVideoContainer');
  mainContainer.innerHTML = `
    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;text-align:center;">
      <div>
        <h2>Meeting Ended</h2>
        <p>You can close this window</p>
      </div>
    </div>
  `;
}
</script>
</body>
</html>