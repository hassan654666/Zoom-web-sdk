<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Zoom Meeting - Auto Join Fullscreen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Zoom Meeting Embedded SDK v4.0.0 -->
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/zoom-meeting-embedded-4.0.0.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background-color: #000;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        /* padding-top: 24px; */
        /* padding-bottom: 24px; */
      }

      #headerBar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 65px;
        background: #1e1e1e;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        z-index: 10000; /* sits above the disclosure banner */
      }

      @media (orientation: landscape) {
        #headerBar { display: none; }
      }

      #meetingContainer {
        flex: 1;
        width: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        background: #252525;
        overflow: hidden;
        
      }

      #meetingSDKElement {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      video {
        aspect-ratio: 16 / 9;
        object-fit: cover;
        border-radius: 8px;
        display: block;
      }

      video::-webkit-media-controls-enclosure {
        overflow: visible !important;
      }

      .zoom-MuiToolbar-root,
      .zoom-MuiTabs-root,
      .zoommtg-drag-video,
      [title="Meeting Information"],
      [aria-label="See apps that are accessing your meeting content"] {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        pointer-events: none !important;
      }

      /* --- Dedicated bottom popper container --- */
      #bottomPanel {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 9999;
      }

      /* LEFT panel for poppers (chat/participants/settings/etc.) */
      /* #leftPanel {
        width: 360px;            /* adjust to taste, mobile: use smaller width */
        /* max-width: 40%;
        min-width: 260px;
        height: 100vh;
        background: rgba(12,12,12,0.98);
        border-right: 1px solid rgba(255,255,255,0.03);
        box-sizing: border-box;
        z-index: 10000; */
        /*display: none; /* start hidden; shown when popper opens */
        /* overflow-y: auto;
        -webkit-overflow-scrolling: touch; */
      /*} */

      /* Ensure poppers render correctly into bottomPanel */
      /* #bottomPanel > .zoom-MuiPopover-root,
      #bottomPanel > .zoom-MuiModal-root,
      #bottomPanel > .zoom-MuiDialog-root {
        position: absolute !important;
        bottom: 0 !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        z-index: 9999 !important;
      } */

      /* Fix for overflow UI in landscape mode */
      /* @media (orientation: landscape) {
        #meetingSDKElement {
          height: 90vh !important;
        }
        #bottomPanel {
          height: 10vh !important;
          max-height: 120px;
        }
      } */

      /* Gallery pagination arrows always visible */
      /* .zm-gallery-view .zm-gallery-page-btn {
        opacity: 1 !important;
        visibility: visible !important;
      }

      .zm-gallery-page-btn {
        z-index: 10000 !important;
      } */
    </style>
  </head>

  <body>
    <!-- <div id="headerBar">Zoom Meeting</div> -->
    <div id="meetingContainer">
      <div id="meetingSDKElement"></div>
      <div id="bottomPanel"></div>
      <!-- <div id="bottomPanel"></div> -->
    </div>

    <script>
      (async () => {
        const meetingSDKElement = document.getElementById("meetingSDKElement");
        const bottomPanel = document.getElementById("bottomPanel");
        // const leftPanel = document.getElementById("leftPanel");
        const client = ZoomMtgEmbedded.createClient();

        // --- Credentials (replace with actual) ---
        const params = new URLSearchParams(window.location.search);
        const meetingNumber = params.get("meetingNumber");
        const signature = decodeURIComponent(params.get("signature") || "");
        const sdkKey = params.get("sdkKey");
        const userName = decodeURIComponent(params.get("name") || "Guest");
        const password = decodeURIComponent(params.get("password") || "").trim();

        try {
          await client.init({
            zoomAppRoot: meetingSDKElement,
            language: "en-US",
            maximumVideosInGalleryView: 1,
            customize: {
              // meeting: {
              //   popper: {
              //     placement: "top",
              //     disableDraggable: true,
              //     anchorElement: meetingSDKElement,
              //   },
              // },
              video: {
                isResizable: false,
                showPipButton: true,
                defaultViewType: 'gallery',
                // popper: {
                //   anchorElement: bottomPanel,
                //   placement: 'bottom',
                //   disableDraggable: true,
                //   disablePortal: true,
                //   offset: { mainAxis: 12 },
                //   disableHideOnClickOutside: false
                // },
                viewSizes: {
                  default: {
                    width: window.innerWidth * 1,
                    height: window.innerHeight * 0.92,
                  },
                  ribbon: {
                    width: window.innerWidth * 1,
                    height: window.innerHeight * 0.9,
                  },
                },
              },
              chat: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              participants: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              setting: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              reactions: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              captionSettings: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              activeApps: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              // meetingInfo: {
              //   popper: {
              //     placement: "bottom",
              //     disableDraggable: true,
              //     anchorElement: bottomPanel,
              //   },
              // },
              meetingInfo: [
                "topic",
                "host",
                "mn",
                "pwd",
                "participant",
                "invite",
                "joinTime",
                "whiteboard",
              ],
              // toolbar: {
              //   buttons: [],
              // },
              branding: {
                name: "",
                logo: "",
                hideMeetingInfo: true,
              },
              // toolbar: {
              //   buttons: [
              //     "microphone",
              //     "camera",
              //     "participants",
              //     "chat",
              //     // "share",
              //     // "whiteboard",
              //     // "recording",
              //     "settings",
              //     "leave",
              //   ],
              //   hide: ["share", "whiteboard", "recording"],
              //   alwaysVisibleButtons: ["chat"]
              // }
            },
          });

          await client.join({
            signature: signature,
            sdkKey: sdkKey,
            meetingNumber: meetingNumber,
            password: password,
            userName: userName,
          });

          console.log("✅ Joined meeting automatically!");

          // ✅ Updated for Zoom Web Meeting SDK v4.0.0
          // const forceBottomPanelPlacement = () => {
          //   //const bottomPanel = document.getElementById('bottomPanel'); // Ensure this exists
          //   if (!bottomPanel) return;

          //   // New Zoom popovers & modals are mounted under body with these classes
          //   const poppers = document.querySelectorAll(
          //     '.zoom-MuiPopper-root, .zoom-MuiModal-root'
          //   );

          //   poppers.forEach((p) => {
          //     // Only move visible & unmounted ones into bottom panel
          //     if (p.parentElement !== bottomPanel && p.offsetParent !== null) {
          //       bottomPanel.appendChild(p);
          //     }
          //   });
          // };

          // // Observe for new Zoom popper/modal mounts
          // const observer = new MutationObserver(() => {
          //   forceBottomPanelPlacement();
          // });

          // // Observe entire body because Zoom mounts globally
          // observer.observe(document.body, {
          //   childList: true,
          //   subtree: true,
          // });

          // --- Meeting End Notification ---
          client.on("connection-change", (payload) => {
            if (payload.state === "Closed") {
              console.log("📩 Meeting ended, notifying app...");
              if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({ action: "meetingEnded" })
                );
              } else {
                console.log("⚠️ ReactNativeWebView not found");
              }
            }
            disablePiP();
          });

          // --- Dynamic Resize Handler ---
          const handleResize = () => {
            const width = window.innerWidth;
            const height = window.innerHeight;

            client.updateVideoOptions({
              viewSizes: {
                default: { width: width * 1, height: height * 0.92 },
                ribbon: { width: width * 1, height: height * 0.9 },
              },
            });

            console.log("📱 Rotated/resized:", width, "x", height);
          };

          window.addEventListener("resize", handleResize);
          handleResize();

          let pipEnabled = false;
          let zoomClientInstance = null; // store your Zoom meeting instance if needed

          // --- Wait for video metadata before enabling PiP ---
          async function waitForVideoReady() {
            const video = document.querySelector("video");
            if (!video) return null;
            if (video.readyState >= 1) return video; // metadata loaded
            return new Promise(resolve => {
              video.addEventListener("loadedmetadata", () => resolve(video), { once: true });
            });
          }

          async function enablePiP() {
            try {
              const video = await waitForVideoReady();
              if (!video) return console.warn("No video element available yet.");
              if (document.pictureInPictureElement) return;
              if (!pipEnabled) {
                await video.requestPictureInPicture();
                pipEnabled = true;
                if (window.ReactNativeWebView) {
                  window.ReactNativeWebView.postMessage(
                    JSON.stringify({ pip: "entered" })
                  );
                } else {
                  console.log("⚠️ ReactNativeWebView not found");
                }
                console.log("✅ PiP enabled");
              }
            } catch (err) {
              console.error("PiP failed:", err);
            }
          }

          async function disablePiP() {
            try {
              if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
                pipEnabled = false;
                console.log("✅ PiP disabled");
              }
            } catch (err) {
              console.error("Exit PiP failed:", err);
            }
          }

          // ✅ Prevent PiP on first load
          window.onload = () => {
            pipEnabled = false;
            disablePiP();
            console.log("🔹 PiP is disabled on first load");
          };

          // ✅ React Native bridge access
          window.enablePiP = enablePiP;
          window.disablePiP = disablePiP;

          // ✅ Auto-enable PiP when app backgrounds (optional)
          document.addEventListener("visibilitychange", () => {
            if (document.hidden) enablePiP();
          });

          function hideZoomTopToolbar() {
            const selectors = [
              '.zoom-MuiToolbar-root',     // The whole top bar container
              '.zoom-MuiTabs-root',        // View mode tabs
              '[title="Meeting Information"]', // Info icon button
              '[aria-label="See apps that are accessing your meeting content"]', // Marketplace icon
              '.zoommtg-drag-video'        // Drag bar
            ];

            selectors.forEach(sel => {
              document.querySelectorAll(sel).forEach(el => {
                el.style.display = 'none';
                el.style.visibility = 'hidden';
                el.style.height = '0';
                el.style.pointerEvents = 'none';
              });
            });
          }

          // Initial removal after joining
          setTimeout(hideZoomTopToolbar, 2000);

          // Watch for reinjection
          const observer2 = new MutationObserver(() => hideZoomTopToolbar());
          observer2.observe(document.body, { childList: true, subtree: true });

          // window.addEventListener("orientationchange", handleOrientationChange);
          // window.addEventListener("resize", handleOrientationChange);

          // function handleOrientationChange() {
          //   console.log("Orientation:", screen.orientation.type);
          //   restartCamera();
          // }

        } catch (error) {
          console.error("❌ Error joining meeting:", error);
          window.ReactNativeWebView.postMessage(
            JSON.stringify({ action: "meetingEnded" })
          );
        }
      })();
    </script>
  </body>
</html>
