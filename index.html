<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
  <title>Zoom Meeting</title>

  <!-- Zoom SDK -->
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
  <script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      touch-action: none;
    }

    /* Fullscreen container that adapts to all devices */
    #meetingContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #meetingSDKElement {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Force Zoom video grid to use full available area */
    #meetingSDKElement > div {
      width: 100% !important;
      height: 100% !important;
      max-width: 100% !important;
      max-height: 100% !important;
    }

    /* Zoom toolbar fix */
    .zmmtg-root,
    .zmmtg-toolbar,
    .footer__layout {
      width: 100vw !important;
      left: 0 !important;
      bottom: 0 !important;
      position: fixed !important;
      z-index: 999 !important;
    }

    /* Self video Picture-in-Picture */
    .self-video-pip {
      position: fixed !important;
      bottom: 16px !important;
      right: 16px !important;
      width: 120px !important;
      height: 160px !important;
      border: 2px solid #fff !important;
      border-radius: 8px !important;
      overflow: hidden !important;
      z-index: 10000 !important;
      background: #000 !important;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6) !important;
    }

    /* Hide self video in gallery */
    .self-video-original {
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* Loading and error */
    #loading, #error {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 20000;
    }

    #error {
      flex-direction: column;
      display: none;
    }

    .retry-btn {
      background: #2D8CFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-size: 16px;
    }

    /* Handle landscape rotation */
    @media (orientation: landscape) {
      .self-video-pip {
        width: 160px !important;
        height: 120px !important;
      }
    }

    /* Force body to resize correctly when rotating */
    @media screen and (orientation: portrait), screen and (orientation: landscape) {
      html, body, #meetingContainer, #meetingSDKElement {
        width: 100vw;
        height: 100vh;
      }
    }
  </style>
</head>
<body>
  <div id="meetingContainer">
    <div id="meetingSDKElement"></div>
  </div>

  <div id="loading">Joining meeting...</div>

  <div id="error">
    <h2>Unable to Join Meeting</h2>
    <p id="errorMessage"></p>
    <button class="retry-btn" onclick="retryJoin()">Try Again</button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const meetingNumber = params.get("meetingNumber");
    const signature = decodeURIComponent(params.get("signature") || "");
    const sdkKey = params.get("sdkKey");
    const userName = decodeURIComponent(params.get("name") || "Guest");
    const password = decodeURIComponent(params.get("password") || "").trim();

    let zoomClient = null;
    let observer = null;
    let selfVideoPIP = null;
    let isInitialized = false;

    window.addEventListener('DOMContentLoaded', startMeeting);
    window.addEventListener('orientationchange', adjustLayout);
    window.addEventListener('resize', adjustLayout);

    async function startMeeting() {
      try {
        if (!meetingNumber || !signature || !sdkKey) throw new Error('Missing meeting parameters');

        if (typeof window.ZoomMtgEmbedded === 'undefined') throw new Error('Zoom SDK not loaded');

        zoomClient = window.ZoomMtgEmbedded.createClient();

        await zoomClient.init({
          zoomAppRoot: document.getElementById('meetingSDKElement'),
          language: 'en-US',
          patchJsMedia: true,
        });

        zoomClient.on('connection-change', (payload) => {
          if (payload.state === 'Closed') notifyAppAndClose();
        });

        zoomClient.on('user-updated', handleUserUpdate);

        await zoomClient.join({
          sdkKey,
          signature,
          meetingNumber,
          password,
          userName,
        });

        document.getElementById('loading').style.display = 'none';
        isInitialized = true;

        setTimeout(startVideoObservation, 2000);
      } catch (error) {
        showError(error.message);
      }
    }

    function handleUserUpdate() {
      setTimeout(createSelfVideoPIP, 500);
    }

    function startVideoObservation() {
      observer = new MutationObserver(() => {
        clearTimeout(window.videoUpdateTimeout);
        window.videoUpdateTimeout = setTimeout(createSelfVideoPIP, 300);
      });

      observer.observe(document.getElementById('meetingSDKElement'), {
        childList: true,
        subtree: true,
      });

      createSelfVideoPIP();
    }

    function createSelfVideoPIP() {
      if (!isInitialized) return;
      const meetingElement = document.getElementById('meetingSDKElement');
      if (!meetingElement) return;

      const videos = meetingElement.querySelectorAll('video');
      let selfVideo = null;

      videos.forEach((v) => {
        const container = v.closest('[class*="video-container"]');
        if (container && (container.innerText.includes(userName) || !selfVideo)) {
          selfVideo = v;
        }
      });

      if (selfVideo && !selfVideoPIP) {
        selfVideoPIP = document.createElement('video');
        selfVideoPIP.className = 'self-video-pip';
        selfVideoPIP.autoplay = true;
        selfVideoPIP.muted = true;
        selfVideoPIP.playsInline = true;
        selfVideoPIP.srcObject = selfVideo.srcObject || selfVideo.src;
        document.body.appendChild(selfVideoPIP);
        selfVideo.closest('[class*="video-container"]')?.classList.add('self-video-original');
      } else if (selfVideo && selfVideoPIP && selfVideo.srcObject !== selfVideoPIP.srcObject) {
        selfVideoPIP.srcObject = selfVideo.srcObject;
      }
    }

    function adjustLayout() {
      if (selfVideoPIP) {
        if (window.innerHeight > window.innerWidth) {
          selfVideoPIP.style.width = '120px';
          selfVideoPIP.style.height = '160px';
        } else {
          selfVideoPIP.style.width = '160px';
          selfVideoPIP.style.height = '120px';
        }
      }

      const sdkEl = document.getElementById('meetingSDKElement');
      sdkEl.style.width = `${window.innerWidth}px`;
      sdkEl.style.height = `${window.innerHeight}px`;
    }

    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      const e = document.getElementById('error');
      e.style.display = 'flex';
      document.getElementById('errorMessage').textContent = msg;
    }

    function retryJoin() {
      document.getElementById('error').style.display = 'none';
      document.getElementById('loading').style.display = 'flex';
      if (observer) observer.disconnect();
      if (selfVideoPIP) selfVideoPIP.remove();
      selfVideoPIP = null;
      isInitialized = false;
      setTimeout(startMeeting, 1000);
    }

    function notifyAppAndClose() {
      if (observer) observer.disconnect();
      if (selfVideoPIP) selfVideoPIP.remove();
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ action: 'meetingEnded' }));
      } else {
        alert('Meeting ended. You can close this window.');
      }
    }
  </script>
</body>
</html>
