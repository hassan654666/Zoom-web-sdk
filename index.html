<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Zoom Meeting</title>

<!-- Zoom Embedded SDK -->
<script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
<script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
<script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
<script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
<script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
<script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100vw; height: 100vh; overflow: hidden;
  background: #000; font-family: sans-serif;
}
#meetingContainer, #meetingSDKElement {
  width: 100vw; height: 100vh; position: fixed; top: 0; left: 0;
  background: #000;
}
#meetingSDKElement > div {
  width: 100vw !important; height: 100vh !important;
  position: fixed !important; top: 0 !important; left: 0 !important;
}
.self-video-pip {
  position: fixed; bottom: 20px; right: 20px;
  width: 140px; height: 180px;
  border: 2px solid #fff; border-radius: 8px;
  background: #000; z-index: 10000; overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.6);
}
.self-video-pip video {
  width: 100%; height: 100%; object-fit: cover;
}
@media (orientation: landscape) {
  .self-video-pip { width: 180px; height: 120px; }
}
@media (max-width: 768px) {
  .self-video-pip { width: 120px; height: 160px; }
}
#loading {
  position: fixed; top:0; left:0; width:100vw; height:100vh;
  background:#000; color:#fff; display:flex;
  align-items:center; justify-content:center; font-size:18px;
  z-index:9999;
}
</style>
</head>

<body>
<div id="meetingContainer">
  <div id="meetingSDKElement"></div>
</div>
<div id="loading">Joining Zoom meeting...</div>

<script>
const params = new URLSearchParams(window.location.search);
const meetingNumber = params.get("meetingNumber");
const sdkKey = params.get("sdkKey");
const signature = decodeURIComponent(params.get("signature") || "");
const userName = decodeURIComponent(params.get("name") || "Guest");
const password = decodeURIComponent(params.get("password") || "");

const client = ZoomMtgEmbedded.createClient();
let selfPIP = null;
let hasJoined = false;

const meetingSDKElement = document.getElementById('meetingSDKElement');
client.init({
  zoomAppRoot: meetingSDKElement,
  language: 'en-US',
  customize: {
    video: { isResizable: true },
    chat: { popper: { disableDraggable: true } },
    meetingInfo: [ 'topic', 'host', 'mn' ]
  }
});

client.join({
  signature,
  sdkKey,
  meetingNumber,
  userName,
  password
}).then(() => {
  document.getElementById('loading').style.display = 'none';
  hasJoined = true;
  maintainLayout();
  setInterval(maintainLayout, 1000);
  createSelfPIP();
}).catch(err => {
  console.error('Join error', err);
  document.getElementById('loading').innerText = "Failed to join meeting.";
});

function maintainLayout() {
  const root = document.getElementById('meetingSDKElement');
  if (!root) return;
  root.style.width = window.innerWidth + 'px';
  root.style.height = window.innerHeight + 'px';
  const children = root.querySelectorAll(':scope > div');
  children.forEach(div => {
    div.style.width = '100vw';
    div.style.height = '100vh';
    div.style.position = 'fixed';
    div.style.top = 0;
    div.style.left = 0;
  });
}
window.addEventListener('resize', maintainLayout);

// Detect and extract local video for PIP
function findLocalVideo() {
  const vids = document.querySelectorAll('video');
  for (const v of vids) {
    const container = v.closest('[class*="video-container"],[class*="video-item"]');
    if (container && container.innerText.includes(userName)) {
      return v;
    }
  }
  return vids.length ? vids[0] : null;
}

function createSelfPIP() {
  const existing = document.querySelector('.self-video-pip');
  if (existing) existing.remove();

  const localVid = findLocalVideo();
  if (!localVid) {
    setTimeout(createSelfPIP, 2000);
    return;
  }

  // keep original hidden to maintain stream
  localVid.classList.add('self-video-original');
  localVid.style.opacity = '0';
  localVid.style.position = 'absolute';
  localVid.style.left = '-9999px';
  localVid.style.top = '-9999px';

  // clone stream for PIP
  const pip = document.createElement('div');
  pip.className = 'self-video-pip';
  const vidClone = document.createElement('video');
  vidClone.autoplay = true;
  vidClone.muted = true;
  vidClone.playsInline = true;
  if (localVid.srcObject) vidClone.srcObject = localVid.srcObject;
  pip.appendChild(vidClone);
  document.body.appendChild(pip);
  selfPIP = pip;
}
</script>
</body>
</html>
