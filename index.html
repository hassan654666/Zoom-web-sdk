<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Zoom Meeting</title>

    <!-- Zoom Web SDK -->
    <script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        background-color: #000;
        overflow: hidden;
      }

      #meetingSDKElement {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
      }

      #errorBox {
        color: #ff4d4d;
        text-align: center;
        margin-top: 20px;
        font-family: sans-serif;
      }

      #loading {
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: sans-serif;
        font-size: 16px;
      }
    </style>
  </head>

  <body>
    <div id="meetingSDKElement"></div>
    <div id="loading">Joining meeting...</div>
    <div id="errorBox"></div>

    <script>
      window.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const meetingNumber = params.get("meetingNumber");
        const signature = decodeURIComponent(params.get("signature") || "");
        const sdkKey = params.get("sdkKey");
        const userName = decodeURIComponent(params.get("name") || "Guest");
        const password = decodeURIComponent(params.get("password") || "").trim();

        const loading = document.getElementById("loading");
        const errorBox = document.getElementById("errorBox");

        if (!meetingNumber || !signature || !sdkKey) {
          errorBox.innerText = "❌ Missing required parameters.";
          loading.style.display = "none";
          return;
        }

        try {
          const client = window.ZoomMtgEmbedded.createClient();
          const meetingSDKElement = document.getElementById("meetingSDKElement");

          await client.init({
            zoomAppRoot: meetingSDKElement,
            language: "en-US",
            customize: {
              video: { isResizable: true },
              meetingInfo: [
                "topic",
                "host",
                "mn",
                "participant",
                "invite",
                "joinTime",
                "whiteboard",
              ],
            },
          });

          await client.join({
            sdkKey,
            signature,
            meetingNumber,
            password,
            userName,
          });

          loading.style.display = "none";
          console.log("✅ Joined meeting successfully");

          // Detect when meeting ends
          client.on("connection-change", (payload) => {
            if (payload.state === "Closed") {
              notifyApp("meetingEnded");
            }
          });
        } catch (err) {
          console.error("❌ Error joining meeting:", err);
          errorBox.innerText = "❌ Failed to join meeting. Check console.";
          loading.style.display = "none";
        }

        // Notify React Native app
        function notifyApp(action) {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({ action }));
          } else {
            alert("Meeting ended — you can close this tab.");
          }
        }
      });
    </script>
  </body>
</html>
