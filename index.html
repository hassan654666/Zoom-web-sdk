<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Zoom Meeting - Auto Join Fullscreen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Zoom Meeting Embedded SDK v4.0.0 -->
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/zoom-meeting-embedded-4.0.0.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background-color: #000;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #meetingContainer {
        flex: 1;
        width: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        background: #000;
      }

      #meetingSDKElement {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      /* --- Dedicated bottom popper container --- */
      #bottomPanel {
        width: 100%;
        height: 30vh;
        max-height: 300px;
        background: rgba(20, 20, 20, 0.98);
        position: relative;
        overflow-y: auto;
        display: none; /* shown dynamically */
        z-index: 9999;
      }

      /* Ensure poppers render correctly into bottomPanel */
      .zm-popover-content,
      .zm-dialog,
      .zm-modal,
      .zm-modal-content,
      .ReactModal__Content {
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
        height: 100% !important;
        border-radius: 0 !important;
      }

      /* Fix for overflow UI in landscape mode */
      @media (orientation: landscape) {
        #meetingSDKElement {
          height: 90vh !important;
        }
        #bottomPanel {
          height: 10vh !important;
          max-height: 120px;
        }
      }

      /* Gallery pagination arrows always visible */
      .zm-gallery-view .zm-gallery-page-btn {
        opacity: 1 !important;
        visibility: visible !important;
      }

      .zm-gallery-page-btn {
        z-index: 10000 !important;
      }
    </style>
  </head>

  <body>
    <div id="meetingContainer">
      <div id="meetingSDKElement"></div>
      <div id="bottomPanel"></div>
    </div>

    <script>
      (async () => {
        const meetingSDKElement = document.getElementById("meetingSDKElement");
        const bottomPanel = document.getElementById("bottomPanel");
        const client = ZoomMtgEmbedded.createClient();

        // --- Credentials (replace with actual) ---
        const params = new URLSearchParams(window.location.search);
        const meetingNumber = params.get("meetingNumber");
        const signature = decodeURIComponent(params.get("signature") || "");
        const sdkKey = params.get("sdkKey");
        const userName = decodeURIComponent(params.get("name") || "Guest");
        const password = decodeURIComponent(params.get("password") || "").trim();

        try {
          await client.init({
            zoomAppRoot: meetingSDKElement,
            language: "en-US",
            maximumVideosInGalleryView: 1,
            customize: {
              video: {
                isResizable: true,
               video: {
                  popper: {
                    anchorElement: bottomPanel,
                    placement: 'bottom',
                    disableDraggable: true,
                    disablePortal: true,
                    offset: { mainAxis: 12 },
                    disableHideOnClickOutside: false
                  }
                },
                viewSizes: {
                  default: {
                    width: window.innerWidth,
                    height: window.innerHeight * 0.7,
                  },
                  ribbon: {
                    width: window.innerWidth,
                    height: window.innerHeight * 0.7,
                  },
                },
              },
              chat: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              participants: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
              settings: {
                popper: {
                  placement: "bottom",
                  disableDraggable: true,
                  anchorElement: bottomPanel,
                },
              },
            },
          });

          await client.join({
            signature: signature,
            sdkKey: sdkKey,
            meetingNumber: meetingNumber,
            password: password,
            userName: userName,
          });

          console.log("‚úÖ Joined meeting automatically!");

          // --- Show bottomPanel when a popper opens ---
          const observer = new MutationObserver(() => {
            const popperOpen = document.querySelector(".zm-modal, .zm-dialog, .zm-popover-content");
            bottomPanel.style.display = popperOpen ? "block" : "none";
          });
          observer.observe(document.body, { childList: true, subtree: true });

          // --- Meeting End Notification ---
          client.on("connection-change", (payload) => {
            if (payload.state === "Closed") {
              console.log("üì© Meeting ended, notifying app...");
              if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({ action: "meetingEnded" })
                );
              } else {
                console.log("‚ö†Ô∏è ReactNativeWebView not found");
              }
            }
          });

          // --- Dynamic Resize Handler ---
          const handleResize = () => {
            const width = window.innerWidth;
            const height = window.innerHeight;

            client.updateVideoOptions({
              viewSizes: {
                default: { width: width, height: height * 0.7 },
                ribbon: { width: width, height: height * 0.7 },
              },
            });

            console.log("üì± Rotated/resized:", width, "x", height);
          };

          window.addEventListener("resize", handleResize);
          handleResize();

        } catch (error) {
          console.error("‚ùå Error joining meeting:", error);
        }
      })();
    </script>
  </body>
</html>
