<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Zoom Meeting</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <script src="https://source.zoom.us/3.12.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/redux.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/redux-thunk.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/lib/vendor/lodash.min.js"></script>
    <script src="https://source.zoom.us/3.12.0/zoom-meeting-embedded-3.12.0.min.js"></script>
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        width: 100%;
        background: #000;
        overflow: hidden;
      }
      #meetingSDKElement {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #errorBox {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        color: #ff4d4d;
        font-size: 14px;
      }
      #loading {
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      #leaveBtn {
        position: absolute;
        top: 15px;
        left: 15px;
        background-color: #ff3b30;
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        z-index: 10000;
      }
      .fullscreen-btn {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        color: white;
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 6px;
        cursor: pointer;
        z-index: 9999;
      }
      .participant-tile.fullscreen {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9998;
        background: #000;
      }
    </style>
  </head>
  <body>
    <div id="meetingSDKElement"></div>
    <div id="errorBox"></div>
    <div id="loading">Joining meeting...</div>
    <button id="leaveBtn">Leave Meeting</button>

    <script>
      async function main() {
        const params = new URLSearchParams(window.location.search);
        const meetingNumber = params.get("meetingNumber");
        const sdkKey = params.get("sdkKey");
        const signature = decodeURIComponent(params.get("signature") || "");
        const userName = decodeURIComponent(params.get("name") || "Guest");
        const password = decodeURIComponent(params.get("password") || "");

        const errorBox = document.getElementById("errorBox");
        const loading = document.getElementById("loading");
        const leaveBtn = document.getElementById("leaveBtn");

        if (!meetingNumber || !sdkKey || !signature) {
          showError("Missing meeting parameters");
          return;
        }

        try {
          const client = window.ZoomMtgEmbedded.createClient();
          const meetingSDKElement = document.getElementById("meetingSDKElement");

          await client.init({
            zoomAppRoot: meetingSDKElement,
            language: "en-US",
            patchJsMedia: true,
          });

          await client.join({
            sdkKey,
            signature,
            meetingNumber,
            password,
            userName,
          });

          loading.style.display = "none";

          // ðŸŸ¥ Leave meeting
          leaveBtn.onclick = async () => {
            try {
              await client.leave();
              notifyApp({ action: "exitMeeting" });
            } catch (err) {
              showError("Failed to leave meeting");
            }
          };

          // ðŸ§© Observe tiles and add fullscreen toggle
          const observer = new MutationObserver(() => {
            document
              .querySelectorAll(".participant-tile:not([data-fs])")
              .forEach((tile) => {
                tile.dataset.fs = "1";
                const btn = document.createElement("button");
                btn.className = "fullscreen-btn";
                btn.innerText = "Full Screen";
                btn.onclick = () => {
                  const isFull = tile.classList.toggle("fullscreen");
                  btn.innerText = isFull ? "Exit" : "Full Screen";
                };
                tile.appendChild(btn);
              });
          });
          observer.observe(meetingSDKElement, { childList: true, subtree: true });
        } catch (err) {
          console.error(err);
          showError("Failed to join meeting");
        }

        function showError(msg) {
          loading.style.display = "none";
          errorBox.innerText = "âŒ " + msg;
          errorBox.style.display = "block";
          notifyApp({ action: "error", message: msg });
        }

        function notifyApp(data) {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify(data));
          } else {
            alert(data.message || data.action);
          }
        }

        // Handle app background/foreground messages
        window.addEventListener("message", (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.action === "appStateChanged") {
              console.log("App state:", data.state);
            }
          } catch {}
        });
      }

      main();
    </script>
  </body>
</html>
